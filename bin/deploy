#!/usr/bin/env bash
set -euo pipefail

# Ethereum Node Deployment Script
# Interactive menu-driven deployment system

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CONFIG_DIR="$PROJECT_ROOT/config"
LIB_DIR="$PROJECT_ROOT/lib/deploy"
TEMP_COMPOSE="$PROJECT_ROOT/docker-compose.generated.yaml"

# Source utilities
if [ -f "$LIB_DIR/utils.sh" ]; then
    source "$LIB_DIR/utils.sh"
fi

# Source state manager
if [ -f "$LIB_DIR/state-manager.sh" ]; then
    source "$LIB_DIR/state-manager.sh"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SELECTED_EC=""
SELECTED_CC=""
SELECTED_MEV=""
SELECTED_VC=""
SELECTED_DVT=""
SELECTED_NETWORK="mainnet"

# Load existing config if available
load_config() {
    if [ -f "$CONFIG_DIR/.deployment" ]; then
        source "$CONFIG_DIR/.deployment"
    fi
}

# Save configuration
save_config() {
    mkdir -p "$CONFIG_DIR"
    # Use printf to safely handle special characters
    {
        printf "SELECTED_EC=%s\n" "${SELECTED_EC:-}"
        printf "SELECTED_CC=%s\n" "${SELECTED_CC:-}"
        printf "SELECTED_MEV=%s\n" "${SELECTED_MEV:-}"
        printf "SELECTED_VC=%s\n" "${SELECTED_VC:-}"
        printf "SELECTED_DVT=%s\n" "${SELECTED_DVT:-}"
        printf "SELECTED_NETWORK=%s\n" "${SELECTED_NETWORK:-mainnet}"
    } > "$CONFIG_DIR/.deployment"
}

# Print header
print_header() {
    clear
    # Direct spacing for perfect centering (no calculations)
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                     ${GREEN}Ethereum Node Tools${NC}                       ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                ${YELLOW}Created by: stv.z8k@gmail.com${NC}                  ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Get container info (uptime and image version)
get_container_info() {
    local service_name="$1"
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    
    if [ ! -f "$compose_file" ]; then
        echo ""
        return
    fi
    
    # Get container name from compose file or use service name
    local container_name=""
    if command_exists docker; then
        # Try to find running container by service name
        container_name=$(docker compose -f "$compose_file" ps --format "{{.Name}}" "$service_name" 2>/dev/null | head -1)
        
        if [ -z "$container_name" ]; then
            # Try alternative: find by service name pattern
            container_name=$(docker ps --filter "label=com.docker.compose.service=$service_name" --format "{{.Names}}" 2>/dev/null | head -1)
        fi
        
        if [ -z "$container_name" ]; then
            # Try to find by unified container name pattern
            case "$service_name" in
                execution-client)
                    container_name=$(docker ps --filter "name=execution-client-" --format "{{.Names}}" 2>/dev/null | head -1)
                    ;;
                consensus-client)
                    container_name=$(docker ps --filter "name=consensus-client-" --format "{{.Names}}" 2>/dev/null | head -1)
                    ;;
                mev-boost)
                    container_name=$(docker ps --filter "name=mev-boost-" --format "{{.Names}}" 2>/dev/null | head -1)
                    ;;
                validator-client|*-vc)
                    container_name=$(docker ps --filter "name=validator-client-" --format "{{.Names}}" 2>/dev/null | head -1)
                    ;;
            esac
        fi
    fi
    
    if [ -z "$container_name" ]; then
        echo ""
        return
    fi
    
    # Get container info
    local container_info=$(docker inspect "$container_name" 2>/dev/null)
    if [ -z "$container_info" ]; then
        echo ""
        return
    fi
    
    # Extract uptime
    local started_at=""
    local image_version=""
    
    if command_exists jq && echo "$container_info" | jq -e . >/dev/null 2>&1; then
        started_at=$(echo "$container_info" | jq -r '.[0].State.StartedAt' 2>/dev/null)
        image_version=$(echo "$container_info" | jq -r '.[0].Config.Image' 2>/dev/null)
    else
        # Fallback without jq
        started_at=$(echo "$container_info" | grep -o '"StartedAt":"[^"]*"' | cut -d'"' -f4 2>/dev/null)
        image_version=$(echo "$container_info" | grep -o '"Image":"[^"]*"' | cut -d'"' -f4 2>/dev/null)
    fi
    
    # Calculate uptime
    local uptime_str=""
    if [ -n "$started_at" ] && [ "$started_at" != "null" ] && [ "$started_at" != "0001-01-01T00:00:00Z" ]; then
        # Parse ISO 8601 timestamp and calculate uptime
        if date -d "$started_at" >/dev/null 2>&1; then
            # GNU date (Linux)
            local started_epoch=$(date -d "$started_at" +%s 2>/dev/null)
        elif date -j -f "%Y-%m-%dT%H:%M:%S" "${started_at%Z}" +%s >/dev/null 2>&1; then
            # BSD date (macOS)
            local started_epoch=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${started_at%Z}" +%s 2>/dev/null)
        else
            # Fallback: try to parse with date command
            local started_epoch=$(date +%s -d "$started_at" 2>/dev/null || echo "")
        fi
        
        if [ -n "$started_epoch" ]; then
            local current_epoch=$(date +%s)
            local uptime_seconds=$((current_epoch - started_epoch))
            
            if [ $uptime_seconds -gt 0 ]; then
                local days=$((uptime_seconds / 86400))
                local hours=$(((uptime_seconds % 86400) / 3600))
                local minutes=$(((uptime_seconds % 3600) / 60))
                
                if [ $days -gt 0 ]; then
                    uptime_str="${days}d ${hours}h"
                elif [ $hours -gt 0 ]; then
                    uptime_str="${hours}h ${minutes}m"
                else
                    uptime_str="${minutes}m"
                fi
            fi
        fi
    fi
    
    # Extract version from image (e.g., "nethermind/nethermind:1.35.2" -> "1.35.2")
    local version=""
    if [ -n "$image_version" ] && [ "$image_version" != "null" ]; then
        version=$(echo "$image_version" | sed 's/.*://' | sed 's/^v//')
    fi
    
    # Get container status from docker compose ps
    local status=""
    if [ -n "$container_name" ]; then
        status=$(docker compose -f "$compose_file" ps --format "{{.Status}}" "$service_name" 2>/dev/null | head -1)
        if [ -z "$status" ]; then
            # Try alternative method
            status=$(docker ps --filter "name=$container_name" --format "{{.Status}}" 2>/dev/null | head -1)
        fi
    fi
    
    # Parse status to extract health status and uptime
    local health_status=""
    local status_uptime=""
    
    if [ -n "$status" ]; then
        # Extract health status (healthy, unhealthy, starting, etc.)
        if echo "$status" | grep -q "healthy"; then
            health_status="healthy"
        elif echo "$status" | grep -q "unhealthy"; then
            health_status="unhealthy"
        elif echo "$status" | grep -q "starting"; then
            health_status="starting"
        elif echo "$status" | grep -q "Restarting"; then
            health_status="restarting"
        elif echo "$status" | grep -q "Exited"; then
            health_status="exited"
        elif echo "$status" | grep -q "Up"; then
            health_status="running"
        else
            health_status="unknown"
        fi
        
        # Extract uptime from status if available (e.g., "Up 5 minutes", "Up 2 hours")
        # Handle formats like "Up 3 minutes (health: starting)" -> extract only "3 minutes"
        if echo "$status" | grep -qE "Up [0-9]+"; then
            # Extract uptime: match "Up X minutes" or "Up X hours" or "Up X seconds" before any parentheses
            if echo "$status" | grep -qE "Up [0-9]+ (seconds|minutes|hours|days)"; then
                status_uptime=$(echo "$status" | sed -E 's/.*Up ([0-9]+ (seconds?|minutes?|hours?|days?)).*/\1/' | head -1)
            else
                # Fallback: extract just the number and unit if format is different
                status_uptime=$(echo "$status" | sed -E 's/.*Up ([0-9]+[^ (]*).*/\1/' | sed 's/ (health:.*//' | sed 's/ (unhealthy.*//' | head -1)
            fi
            # Clean up: remove any trailing spaces
            status_uptime=$(echo "$status_uptime" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        fi
    fi
    
    # Use status uptime if available, otherwise use calculated uptime
    local display_uptime="${status_uptime:-${uptime_str}}"
    
    # Format output: "Version: 1.35.2 | STATUS: healthy(1m)"
    local output=""
    
    if [ -n "$version" ] && [ -n "$health_status" ]; then
        if [ -n "$display_uptime" ]; then
            output="Version: ${version} | STATUS: ${health_status}(${display_uptime})"
        else
            output="Version: ${version} | STATUS: ${health_status}"
        fi
    elif [ -n "$version" ]; then
        if [ -n "$display_uptime" ]; then
            output="Version: ${version} | Uptime: ${display_uptime}"
        else
            output="Version: ${version}"
        fi
    elif [ -n "$health_status" ]; then
        if [ -n "$display_uptime" ]; then
            output="STATUS: ${health_status}(${display_uptime})"
        else
            output="STATUS: ${health_status}"
        fi
    elif [ -n "$display_uptime" ]; then
        output="Uptime: ${display_uptime}"
    fi
    
    if [ -n "$output" ]; then
        echo " (${output})"
    else
        echo ""
    fi
}

# Print current selection
print_selection() {
    # Check if deployment exists
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    local has_deployment=false
    if [ -f "$compose_file" ]; then
        has_deployment=true
    fi
    
    # Calculate running services count
    local running_count=0
    if [ "$has_deployment" = true ]; then
        # Use grep method as primary (more reliable)
        running_count=$(docker compose -f "$compose_file" ps --format "{{.State}}" 2>/dev/null | grep -c "^running$" 2>/dev/null || echo "0")
        
        # Ensure running_count is a valid number
        if [ -z "$running_count" ] || [ "$running_count" = "" ] || ! [[ "$running_count" =~ ^[0-9]+$ ]]; then
            running_count=0
        fi
    fi
    
    # Display status header (replaces "Current Selection:")
    if [ "$has_deployment" = true ] && [ "$running_count" -gt 0 ]; then
        echo -e "${GREEN}Status: Running ($running_count services)${NC}"
    elif [ "$has_deployment" = true ]; then
        echo -e "${YELLOW}Status: Stopped${NC}"
    else
        echo -e "${YELLOW}Status: Not Deployed${NC}"
    fi
    echo ""
    
    # Network
    echo -e "  Network:     ${GREEN}${SELECTED_NETWORK:-not set}${NC}"
    
    # Execution Client
    local ec_display="${SELECTED_EC:-not set}"
    if [ "$ec_display" != "not set" ] && [ -n "$SELECTED_EC" ]; then
        local ec_info=$(get_container_info "execution-client")
        echo -e "  EC:          ${GREEN}${ec_display}${CYAN}${ec_info}${NC}"
    else
        echo -e "  EC:          ${GREEN}${ec_display}${NC}"
    fi
    
    # Consensus Client
    local cc_display="${SELECTED_CC:-not set}"
    if [ "$cc_display" != "not set" ] && [ -n "$SELECTED_CC" ]; then
        local cc_info=$(get_container_info "consensus-client")
        echo -e "  CC:          ${GREEN}${cc_display}${CYAN}${cc_info}${NC}"
    else
        echo -e "  CC:          ${GREEN}${cc_display}${NC}"
    fi
    
    # MEV
    local mev_display="${SELECTED_MEV:-not set}"
    if [ "$mev_display" != "not set" ] && [ -n "$SELECTED_MEV" ]; then
        case "$SELECTED_MEV" in
            mevboost)
                local mev_info=$(get_container_info "mev-boost")
                echo -e "  MEV:         ${GREEN}MEV-Boost${CYAN}${mev_info}${NC}"
                ;;
            commitboost)
                local mev_info=$(get_container_info "commit-boost")
                echo -e "  MEV:         ${GREEN}Commit Boost${CYAN}${mev_info}${NC}"
                ;;
            both)
                local mev_info=$(get_container_info "mev-boost")
                echo -e "  MEV:         ${GREEN}Both${CYAN}${mev_info}${NC}"
                ;;
            *)
                echo -e "  MEV:         ${GREEN}${mev_display}${NC}"
                ;;
        esac
    else
        echo -e "  MEV:         ${GREEN}${mev_display}${NC}"
    fi
    
    # VC/DVT
    local vc_display="${SELECTED_VC:-not set}"
    if [ -n "$SELECTED_VC" ]; then
        local vc_info=""
        case "$SELECTED_VC" in
            lighthouse)
                vc_info=$(get_container_info "lighthouse-vc")
                vc_display="Lighthouse VC"
                ;;
            teku)
                vc_info=$(get_container_info "teku-vc")
                vc_display="Teku VC"
                ;;
            lodestar)
                vc_info=$(get_container_info "lodestar-vc")
                vc_display="Lodestar VC"
                ;;
            *)
                vc_display="$SELECTED_VC"
                ;;
        esac
        echo -e "  VC/DVT:      ${GREEN}${vc_display}${CYAN}${vc_info}${NC}"
    elif [ -n "$SELECTED_DVT" ]; then
        local dvt_info=""
        case "$SELECTED_DVT" in
            obol)
                dvt_info=$(get_container_info "charon")
                vc_display="Obol DVT"
                ;;
            ssv)
                dvt_info=$(get_container_info "ssv-node")
                vc_display="SSV DVT"
                ;;
            *)
                vc_display="$SELECTED_DVT"
                ;;
        esac
        echo -e "  VC/DVT:      ${GREEN}${vc_display}${CYAN}${dvt_info}${NC}"
    else
        echo -e "  VC/DVT:      ${GREEN}${vc_display}${NC}"
    fi
    
    if [ -n "$SELECTED_DVT" ] && [ -z "$SELECTED_VC" ]; then
        echo -e "  DVT Type:    ${GREEN}${SELECTED_DVT}${NC}"
    fi
    
    echo ""
}

# Menu 1: Network Selection
menu_network() {
    print_header
    echo -e "${BLUE}1. Network Selection${NC}"
    if [ -n "$SELECTED_NETWORK" ]; then
        echo -e "${CYAN}Current: ${GREEN}${SELECTED_NETWORK}${NC}"
    else
        echo -e "${CYAN}Current: ${YELLOW}not set${NC}"
    fi
    echo ""
    echo "  1) Mainnet"
    echo "  2) Goerli (deprecated)"
    echo "  3) Sepolia"
    echo "  4) Holesky"
    echo "  0) Back"
    echo ""
    read -p "Select network [1-4]: " choice
    
    case $choice in
        1) SELECTED_NETWORK="mainnet" ;;
        2) SELECTED_NETWORK="goerli" ;;
        3) SELECTED_NETWORK="sepolia" ;;
        4) SELECTED_NETWORK="holesky" ;;
        0) return ;;
        *) echo -e "${RED}Invalid selection${NC}"; sleep 1; menu_network ;;
    esac
    save_config
}

# Menu 2: Execution Client Selection
menu_ec() {
    print_header
    echo -e "${BLUE}2. Execution Client Selection${NC}"
    if [ -n "$SELECTED_EC" ]; then
        echo -e "${CYAN}Current: ${GREEN}${SELECTED_EC}${NC}"
    else
        echo -e "${CYAN}Current: ${YELLOW}not set${NC}"
    fi
    echo ""
    echo "  1) Geth (Go-Ethereum)"
    echo "  2) Nethermind"
    echo "  3) Reth"
    echo "  4) None (Skip Execution Client)"
    echo "  0) Back (Keep Current Selection)"
    echo ""
    read -p "Select Execution Client [1-3, 4, 0]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        echo -e "${RED}No selection made${NC}"
        sleep 1
        menu_ec
        return
    fi
    
    case $choice in
        1) SELECTED_EC="geth" ;;
        2) SELECTED_EC="nethermind" ;;
        3) SELECTED_EC="reth" ;;
        4) SELECTED_EC="" ;;
        0) return ;;
        *) echo -e "${RED}Invalid selection: $choice${NC}"; sleep 1; menu_ec ;;
    esac
    save_config
}

# Menu 3: Consensus Client Selection
menu_cc() {
    print_header
    echo -e "${BLUE}3. Consensus Client Selection${NC}"
    if [ -n "$SELECTED_CC" ]; then
        echo -e "${CYAN}Current: ${GREEN}${SELECTED_CC}${NC}"
    else
        echo -e "${CYAN}Current: ${YELLOW}not set${NC}"
    fi
    echo ""
    echo "  1) Lighthouse"
    echo "  2) Teku"
    echo "  3) Prysm"
    echo "  4) None (Skip Consensus Client)"
    echo "  0) Back (Keep Current Selection)"
    echo ""
    read -p "Select Consensus Client [1-3, 4, 0]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        echo -e "${RED}No selection made${NC}"
        sleep 1
        menu_cc
        return
    fi
    
    case $choice in
        1) SELECTED_CC="lighthouse" ;;
        2) SELECTED_CC="teku" ;;
        3) SELECTED_CC="prysm" ;;
        4) SELECTED_CC="" ;;
        0) return ;;
        *) echo -e "${RED}Invalid selection: $choice${NC}"; sleep 1; menu_cc ;;
    esac
    save_config
}

# Menu 4: MEV Selection
menu_mev() {
    print_header
    echo -e "${BLUE}4. MEV Selection${NC}"
    if [ -n "$SELECTED_MEV" ] && [ "$SELECTED_MEV" != "none" ]; then
        local mev_display=""
        case "$SELECTED_MEV" in
            mevboost) mev_display="MEV-Boost" ;;
            commitboost) mev_display="Commit Boost" ;;
            both) mev_display="Both (MEV-Boost + Commit Boost)" ;;
            *) mev_display="$SELECTED_MEV" ;;
        esac
        echo -e "${CYAN}Current: ${GREEN}${mev_display}${NC}"
    elif [ "$SELECTED_MEV" = "none" ]; then
        echo -e "${CYAN}Current: ${YELLOW}None${NC}"
    else
        echo -e "${CYAN}Current: ${YELLOW}not set${NC}"
    fi
    echo ""
    echo "  1) MEV-Boost"
    echo "  2) Commit Boost"
    echo "  3) Both"
    echo "  4) None (Skip MEV)"
    echo "  0) Back (Keep Current Selection)"
    echo ""
    read -p "Select MEV option [1-4, 0]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        echo -e "${RED}No selection made${NC}"
        sleep 1
        menu_mev
        return
    fi
    
    case $choice in
        1) SELECTED_MEV="mevboost" ;;
        2) SELECTED_MEV="commitboost" ;;
        3) SELECTED_MEV="both" ;;
        4) SELECTED_MEV="none" ;;
        0) return ;;
        *) echo -e "${RED}Invalid selection: $choice${NC}"; sleep 1; menu_mev ;;
    esac
    save_config
}

# Menu 5: Validator Client / DVT Selection
menu_vc_dvt() {
    print_header
    echo -e "${BLUE}5. Validator Client / DVT Selection${NC}"
    if [ -n "$SELECTED_VC" ]; then
        local vc_display=""
        case "$SELECTED_VC" in
            lighthouse) vc_display="Lighthouse VC" ;;
            teku) vc_display="Teku VC" ;;
            lodestar) vc_display="Lodestar VC" ;;
            web3signer) vc_display="Web3Signer" ;;
            *) vc_display="$SELECTED_VC" ;;
        esac
        echo -e "${CYAN}Current: ${GREEN}${vc_display}${NC}"
    elif [ -n "$SELECTED_DVT" ]; then
        local dvt_display=""
        case "$SELECTED_DVT" in
            obol) dvt_display="Obol DVT (Charon)" ;;
            ssv) dvt_display="SSV Network DVT" ;;
            *) dvt_display="$SELECTED_DVT" ;;
        esac
        echo -e "${CYAN}Current: ${GREEN}${dvt_display}${NC}"
    else
        echo -e "${CYAN}Current: ${YELLOW}None${NC}"
    fi
    echo ""
    echo "  1) Lighthouse VC"
    echo "  2) Teku VC"
    echo "  3) Lodestar VC"
    echo "  4) Obol DVT (Charon)"
    echo "  5) SSV Network DVT"
    echo "  6) Web3Signer (External Signer)"
    echo "  7) None (Skip Validator)"
    echo "  0) Back (Keep Current Selection)"
    echo ""
    read -p "Select Validator option [1-7, 0]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        echo -e "${RED}No selection made${NC}"
        sleep 1
        menu_vc_dvt
        return
    fi
    
    case $choice in
        1) SELECTED_VC="lighthouse"; SELECTED_DVT="" ;;
        2) SELECTED_VC="teku"; SELECTED_DVT="" ;;
        3) SELECTED_VC="lodestar"; SELECTED_DVT="" ;;
        4) SELECTED_VC=""; SELECTED_DVT="obol" ;;
        5) SELECTED_VC=""; SELECTED_DVT="ssv" ;;
        6) SELECTED_VC="web3signer"; SELECTED_DVT="" ;;
        7) SELECTED_VC=""; SELECTED_DVT="" ;;
        0) return ;;
        *) echo -e "${RED}Invalid selection: $choice${NC}"; sleep 1; menu_vc_dvt ;;
    esac
    save_config
}

# Filter logs by level
filter_logs_by_level() {
    local level="$1"
    local service="${2:-}"
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    
    if [ ! -f "$compose_file" ]; then
        print_error "No deployment found"
        return 1
    fi
    
    # Set up trap to handle Ctrl+C gracefully
    trap 'echo ""; echo -e "${YELLOW}Log viewing stopped. Returning to menu...${NC}"; sleep 1; trap - INT; return 0' INT
    
    case "$level" in
        error)
            if [ -n "$service" ]; then
                docker compose -f "$compose_file" logs --tail=1000 -f "$service" 2>&1 | grep -iE "(error|err|failed|failure|critical|fatal)" --color=always || true
            else
                docker compose -f "$compose_file" logs --tail=1000 -f 2>&1 | grep -iE "(error|err|failed|failure|critical|fatal)" --color=always || true
            fi
            ;;
        warn)
            if [ -n "$service" ]; then
                docker compose -f "$compose_file" logs --tail=1000 -f "$service" 2>&1 | grep -iE "(warn|warning|wrn)" --color=always || true
            else
                docker compose -f "$compose_file" logs --tail=1000 -f 2>&1 | grep -iE "(warn|warning|wrn)" --color=always || true
            fi
            ;;
        error-warn)
            if [ -n "$service" ]; then
                docker compose -f "$compose_file" logs --tail=1000 -f "$service" 2>&1 | grep -iE "(error|err|failed|failure|critical|fatal|warn|warning|wrn)" --color=always || true
            else
                docker compose -f "$compose_file" logs --tail=1000 -f 2>&1 | grep -iE "(error|err|failed|failure|critical|fatal|warn|warning|wrn)" --color=always || true
            fi
            ;;
        all|*)
            if [ -n "$service" ]; then
                docker compose -f "$compose_file" logs --tail=1000 -f "$service" || true
            else
                docker compose -f "$compose_file" logs --tail=1000 -f || true
            fi
            ;;
    esac
    
    # Remove trap
    trap - INT
}

# View Error/Warn Logs
view_error_warn_logs() {
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    
    if [ ! -f "$compose_file" ]; then
        print_error "No deployment found"
        sleep 2
        return 1
    fi
    
    print_header
    echo -e "${CYAN}View Error/Warn Logs${NC}"
    echo ""
    
    # Get services
    local services
    if command_exists jq; then
        services=$(docker compose -f "$compose_file" ps --format json 2>/dev/null | \
            jq -r '.[] | "\(.Service)"' 2>/dev/null | sort -u)
    else
        services=$(docker compose -f "$compose_file" ps --format "{{.Service}}" 2>/dev/null | sort -u)
    fi
    
    if [ -z "$services" ]; then
        print_warning "No services found"
        sleep 2
        return 1
    fi
    
    local service_list=($services)
    local i=1
    for service in "${service_list[@]}"; do
        echo "  $i) $service"
        i=$((i + 1))
    done
    echo "  0) All services"
    echo ""
    
    read -p "Select service [0-$((i-1))]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        print_error "No selection made"
        sleep 1
        return
    fi
    
    local selected_service=""
    if [ "$choice" = "0" ]; then
        selected_service=""
    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#service_list[@]}" ]; then
        selected_service="${service_list[$((choice-1))]}"
    else
        print_error "Invalid selection: $choice"
        sleep 1
        return
    fi
    
    # Select log level
    clear
    print_header
    echo -e "${CYAN}Select log level:${NC}"
    echo ""
    if [ -n "$selected_service" ]; then
        echo -e "  Service: ${GREEN}$selected_service${NC}"
    else
        echo -e "  Service: ${GREEN}All services${NC}"
    fi
    echo ""
    echo "  1) Error only"
    echo "  2) Warning only"
    echo "  3) Error + Warning"
    echo "  0) Back"
    echo ""
    read -p "Select option [0-3]: " level_choice
    
    case "$level_choice" in
        1)
            clear
            echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
            echo -e "${RED}  Error Logs: ${selected_service:-All services}${NC}"
            echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
            echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
            echo ""
            filter_logs_by_level "error" "$selected_service"
            ;;
        2)
            clear
            echo -e "${YELLOW}════════════════════════════════════════════════════════════${NC}"
            echo -e "${YELLOW}  Warning Logs: ${selected_service:-All services}${NC}"
            echo -e "${YELLOW}════════════════════════════════════════════════════════════${NC}"
            echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
            echo ""
            filter_logs_by_level "warn" "$selected_service"
            ;;
        3)
            clear
            echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
            echo -e "${RED}  Error + Warning Logs: ${selected_service:-All services}${NC}"
            echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
            echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
            echo ""
            filter_logs_by_level "error-warn" "$selected_service"
            ;;
        0)
            return
            ;;
        *)
            print_error "Invalid selection"
            sleep 1
            ;;
    esac
}

# View Logs Menu
view_logs_menu() {
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    
    if [ ! -f "$compose_file" ]; then
        print_error "No deployment found"
        sleep 2
        return 1
    fi
    
    print_header
    echo -e "${CYAN}View Logs (Real-time)${NC}"
    echo ""
    
    # Get services
    local services
    if command_exists jq; then
        services=$(docker compose -f "$compose_file" ps --format json 2>/dev/null | \
            jq -r '.[] | "\(.Service)"' 2>/dev/null | sort -u)
    else
        services=$(docker compose -f "$compose_file" ps --format "{{.Service}}" 2>/dev/null | sort -u)
    fi
    
    if [ -z "$services" ]; then
        print_warning "No services found"
        sleep 2
        return 1
    fi
    
    local service_list=($services)
    local i=1
    for service in "${service_list[@]}"; do
        echo "  $i) $service"
        i=$((i + 1))
    done
    echo "  0) All services"
    echo ""
    
    read -p "Select service [0-$((i-1))]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        print_error "No selection made"
        sleep 1
        return
    fi
    
    local selected_service=""
    if [ "$choice" = "0" ]; then
        selected_service=""
    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#service_list[@]}" ]; then
        selected_service="${service_list[$((choice-1))]}"
    else
        print_error "Invalid selection: $choice"
        sleep 1
        return
    fi
    
    clear
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  Real-time Logs: ${selected_service:-All services}${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
    echo ""
    filter_logs_by_level "all" "$selected_service"
}

# Save Logs Menu
save_logs_menu() {
    local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
    
    if [ ! -f "$compose_file" ]; then
        print_error "No deployment found"
        sleep 2
        return 1
    fi
    
    print_header
    echo -e "${CYAN}Save Logs (Last 1000 lines)${NC}"
    echo ""
    
    # Get services
    local services
    if command_exists jq; then
        services=$(docker compose -f "$compose_file" ps --format json 2>/dev/null | \
            jq -r '.[] | "\(.Service)"' 2>/dev/null | sort -u)
    else
        services=$(docker compose -f "$compose_file" ps --format "{{.Service}}" 2>/dev/null | sort -u)
    fi
    
    if [ -z "$services" ]; then
        print_warning "No services found"
        sleep 2
        return 1
    fi
    
    local service_list=($services)
    local i=1
    for service in "${service_list[@]}"; do
        echo "  $i) $service"
        i=$((i + 1))
    done
    echo "  0) All services"
    echo ""
    
    read -p "Select service [0-$((i-1))]: " choice
    
    # Validate input
    if [ -z "$choice" ]; then
        print_error "No selection made"
        sleep 1
        return
    fi
    
    local selected_service=""
    if [ "$choice" = "0" ]; then
        selected_service=""
    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#service_list[@]}" ]; then
        selected_service="${service_list[$((choice-1))]}"
    else
        print_error "Invalid selection: $choice"
        sleep 1
        return
    fi
    
    # Create logs directory
    local logs_dir="$PROJECT_ROOT/logs"
    mkdir -p "$logs_dir"
    
    # Generate filename
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    local log_file
    if [ -n "$selected_service" ]; then
        log_file="$logs_dir/${selected_service}_${timestamp}.log"
    else
        log_file="$logs_dir/all_services_${timestamp}.log"
    fi
    
    print_info "Saving last 1000 lines to: $log_file"
    
    if [ -n "$selected_service" ]; then
        docker compose -f "$compose_file" logs --tail=1000 "$selected_service" > "$log_file" 2>&1
    else
        docker compose -f "$compose_file" logs --tail=1000 > "$log_file" 2>&1
    fi
    
    if [ $? -eq 0 ]; then
        local line_count=$(wc -l < "$log_file" | tr -d ' ')
        print_success "Logs saved successfully ($line_count lines)"
        echo ""
        echo "File location: $log_file"
        echo ""
        read -p "Press Enter to continue..."
    else
        print_error "Failed to save logs"
        sleep 2
    fi
}

# Edit .env file
edit_env_file() {
    local env_file="$PROJECT_ROOT/.env"
    
    if [ ! -f "$env_file" ]; then
        print_warning ".env file not found. Creating from template..."
        if [ -f "$LIB_DIR/env-setup.sh" ]; then
            bash "$LIB_DIR/env-setup.sh" "${SELECTED_NETWORK:-mainnet}"
        else
            print_error "env-setup.sh not found"
            sleep 2
            return
        fi
    fi
    
    print_header
    echo -e "${BLUE}Edit .env File${NC}"
    echo ""
    echo -e "${CYAN}File location:${NC} $env_file"
    echo ""
    echo "Select editor:"
    echo "  1) nano (recommended)"
    echo "  2) vi/vim"
    echo "  3) View only"
    echo "  0) Back"
    echo ""
    read -p "Select option [0-3]: " editor_choice
    
    case $editor_choice in
        1)
            if command -v nano >/dev/null 2>&1; then
                nano "$env_file"
            else
                print_error "nano not found. Using vi instead..."
                sleep 1
                vi "$env_file"
            fi
            ;;
        2)
            if command -v vi >/dev/null 2>&1; then
                vi "$env_file"
            else
                print_error "vi not found"
                sleep 2
            fi
            ;;
        3)
            print_header
            echo -e "${BLUE}.env File Contents${NC}"
            echo ""
            cat "$env_file"
            echo ""
            read -p "Press Enter to continue..."
            ;;
        0)
            return
            ;;
        *)
            print_error "Invalid selection"
            sleep 1
            ;;
    esac
    
    # Reload environment variables after editing
    if [ -f "$env_file" ]; then
        print_info "Reloading environment variables..."
        set -a
        source "$env_file" 2>/dev/null || true
        set +a
    fi
}

# New Deployment Configuration Menu
new_deployment_menu() {
    while true; do
        print_header
        echo -e "${BLUE}New Deployment - Configuration${NC}"
        echo ""
        
        # Format current selections for display
        local network_display="${SELECTED_NETWORK:-not set}"
        local ec_display="${SELECTED_EC:-not set}"
        local cc_display="${SELECTED_CC:-not set}"
        
        # Format MEV display
        local mev_display="not set"
        if [ -n "$SELECTED_MEV" ]; then
            case "$SELECTED_MEV" in
                mevboost) mev_display="MEV-Boost" ;;
                commitboost) mev_display="Commit Boost" ;;
                both) mev_display="Both" ;;
                none) mev_display="None" ;;
                *) mev_display="$SELECTED_MEV" ;;
            esac
        fi
        
        # Format VC/DVT display
        local vc_display="not set"
        if [ -n "$SELECTED_VC" ]; then
            case "$SELECTED_VC" in
                lighthouse) vc_display="Lighthouse VC" ;;
                teku) vc_display="Teku VC" ;;
                lodestar) vc_display="Lodestar VC" ;;
                web3signer) vc_display="Web3Signer" ;;
                *) vc_display="$SELECTED_VC" ;;
            esac
        elif [ -n "$SELECTED_DVT" ]; then
            case "$SELECTED_DVT" in
                obol) vc_display="Obol DVT" ;;
                ssv) vc_display="SSV DVT" ;;
                *) vc_display="$SELECTED_DVT" ;;
            esac
        fi
        
        echo -e "${CYAN}Configuration:${NC}"
        echo -e "  1) Select Network          ${GREEN}[${network_display}]${NC}"
        echo -e "  2) Select Execution Client ${GREEN}[${ec_display}]${NC}"
        echo -e "  3) Select Consensus Client ${GREEN}[${cc_display}]${NC}"
        echo -e "  4) Select MEV Option       ${GREEN}[${mev_display}]${NC}"
        echo -e "  5) Select Validator Client / DVT ${GREEN}[${vc_display}]${NC}"
        echo -e "  6) Edit .env File"
        echo ""
        echo -e "${GREEN}Deploy:${NC}"
        echo "  7) Deploy Now"
        echo ""
        echo -e "${YELLOW}Tools:${NC}"
        echo "  8) View Generated Compose"
        echo "  9) Reset Configuration"
        echo ""
        echo "  0) Back to Main Menu"
        echo ""
        read -p "Select option [0-9]: " choice
        
        # Validate input
        if [ -z "$choice" ]; then
            echo -e "${RED}No selection made${NC}"
            sleep 1
            continue
        fi
        
        case $choice in
            1) menu_network ;;
            2) menu_ec ;;
            3) menu_cc ;;
            4) menu_mev ;;
            5) menu_vc_dvt ;;
            6) 
                # Edit .env file
                edit_env_file
                ;;
            7) 
                # Deploy
                if [ -z "$SELECTED_NETWORK" ]; then 
                    print_warning "Network not selected"
                    menu_network
                    continue
                fi
                if [ -z "$SELECTED_EC" ]; then 
                    print_warning "Execution Client not selected"
                    menu_ec
                    continue
                fi
                if [ -z "$SELECTED_CC" ]; then 
                    print_warning "Consensus Client not selected"
                    menu_cc
                    continue
                fi
                if [ -z "$SELECTED_MEV" ]; then 
                    print_warning "MEV option not selected"
                    menu_mev
                    continue
                fi
                # VC/DVT is optional - don't force selection
                if [ -z "$SELECTED_VC" ] && [ -z "$SELECTED_DVT" ]; then
                    echo ""
                    print_info "Validator Client / DVT is optional. You can skip this step."
                    read -p "Configure Validator Client / DVT now? [y/N]: " vc_choice
                    if [[ $vc_choice =~ ^[Yy]$ ]]; then
                        menu_vc_dvt
                    else
                        print_info "Skipping Validator Client / DVT configuration"
                    fi
                fi
                deploy
                return
                ;;
            8) 
                if [ -f "$TEMP_COMPOSE" ]; then 
                    less "$TEMP_COMPOSE"
                elif [ -f "$PROJECT_ROOT/docker-compose.generated.yaml" ]; then
                    less "$PROJECT_ROOT/docker-compose.generated.yaml"
                else
                    print_warning "No compose file found"
                    sleep 1
                fi
                ;;
            9) 
                SELECTED_EC=""; SELECTED_CC=""; SELECTED_MEV=""; SELECTED_VC=""; SELECTED_DVT=""; 
                save_config
                print_success "Configuration reset"
                sleep 1
                ;;
            0) return ;;
            *) echo -e "${RED}Invalid selection${NC}"; sleep 1 ;;
        esac
    done
}

# Generate Docker Compose file
generate_compose() {
    print_info "Generating Docker Compose configuration..."
    
    # Use the advanced generator script
    if [ -f "$LIB_DIR/compose-generator.sh" ]; then
        bash "$LIB_DIR/compose-generator.sh"
    else
        print_error "Compose generator not found"
        return 1
    fi
}

# Validate selection
validate_selection() {
    local errors=0
    
    if [ -z "$SELECTED_NETWORK" ]; then
        echo -e "${RED}✗ Network not selected${NC}"
        errors=$((errors + 1))
    fi
    
    if [ -z "$SELECTED_EC" ]; then
        echo -e "${RED}✗ Execution Client not selected${NC}"
        errors=$((errors + 1))
    fi
    
    if [ -z "$SELECTED_CC" ]; then
        echo -e "${RED}✗ Consensus Client not selected${NC}"
        errors=$((errors + 1))
    fi
    
    return $errors
}

# Deploy
deploy() {
    print_header
    print_selection
    
    if ! validate_selection; then
        echo ""
        print_error "Please complete all required selections"
        sleep 2
        return
    fi
    
    # Check prerequisites
    if ! check_docker; then
        return 1
    fi
    
    if ! check_docker_compose; then
        return 1
    fi
    
    # Ensure environment config exists
    local env_file="$PROJECT_ROOT/.env"
    if [ ! -f "$env_file" ]; then
        print_warning "Environment config not found. Creating from template..."
        if [ -f "$LIB_DIR/env-setup.sh" ]; then
            bash "$LIB_DIR/env-setup.sh" "$SELECTED_NETWORK"
            print_info "Please review: $env_file"
            read -p "Press Enter to continue..."
        else
            print_error "Setup script not found. Please create $env_file manually"
            return 1
        fi
    fi
    
    # Check if this is a first-time deployment
    local is_first_deployment=false
    if [ ! -f "$PROJECT_ROOT/docker-compose.generated.yaml" ]; then
        is_first_deployment=true
        print_info "First-time deployment detected"
    fi
    
    # Ensure JWT exists (regenerate on first deployment)
    local jwt_file="$PROJECT_ROOT/security/jwt/$SELECTED_NETWORK/jwt.hex"
    if [ "$is_first_deployment" = "true" ]; then
        print_info "Regenerating JWT secret for first-time deployment..."
        if ! ensure_jwt "$jwt_file" "true"; then
            print_error "Failed to ensure JWT file exists"
            return 1
        fi
    else
        if ! ensure_jwt "$jwt_file"; then
            print_error "Failed to ensure JWT file exists"
            return 1
        fi
    fi
    
    echo ""
    print_info "Generating Docker Compose configuration..."
    if [ -f "$LIB_DIR/compose-generator.sh" ]; then
        bash "$LIB_DIR/compose-generator.sh"
    else
        print_error "Compose generator not found"
        return 1
    fi
    
    echo ""
    echo -e "${YELLOW}════════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Deployment Summary${NC}"
    echo -e "${YELLOW}════════════════════════════════════════════════════════════${NC}"
    echo "  Network:     $SELECTED_NETWORK"
    echo "  EC:          $SELECTED_EC"
    echo "  CC:          $SELECTED_CC"
    echo "  MEV:         ${SELECTED_MEV:-none}"
    echo "  VC/DVT:      ${SELECTED_VC:-none} ${SELECTED_DVT:-}"
    echo -e "${YELLOW}════════════════════════════════════════════════════════════${NC}"
    echo ""
    read -p "Deploy now? [y/N]: " confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        print_info "Deployment cancelled"
        return
    fi
    
    # Load environment variables
    if [ -f "$env_file" ]; then
        set -a
        source "$env_file"
        set +a
        export ENV="$SELECTED_NETWORK"
        export PROJECT_ROOT="$PROJECT_ROOT"
        export NETWORK="$SELECTED_NETWORK"
    fi
    
    echo ""
    print_info "Deploying services..."
    
    # Ensure compose file exists
    if [ ! -f "$TEMP_COMPOSE" ]; then
        print_error "Generated compose file not found: $TEMP_COMPOSE"
        return 1
    fi
    
    if ! docker compose -f "$TEMP_COMPOSE" up -d; then
        print_error "Deployment failed"
        return 1
    fi
    
    if docker compose -f "$TEMP_COMPOSE" ps --format json 2>/dev/null | grep -q '"State":"running"'; then
        echo ""
        print_success "Deployment complete!"
        
        # Save deployment state
        local config_json=$(cat <<EOF
{
  "network": "$SELECTED_NETWORK",
  "ec": "$SELECTED_EC",
  "cc": "$SELECTED_CC",
  "mev": "${SELECTED_MEV:-none}",
  "vc": "${SELECTED_VC:-none}",
  "dvt": "${SELECTED_DVT:-none}",
  "timestamp": "$(date -Iseconds)"
}
EOF
        )
        save_state "$config_json"
        log_deployment "DEPLOY" "$config_json"
        
        echo ""
        echo "Useful commands:"
        echo "  Status:  docker compose -f $TEMP_COMPOSE ps"
        echo "  Logs:    docker compose -f $TEMP_COMPOSE logs -f"
        echo "  Stop:    docker compose -f $TEMP_COMPOSE stop"
        echo "  Remove:  docker compose -f $TEMP_COMPOSE down"
        echo ""
        echo "Use 'Restart / Manage Existing' from main menu for maintenance options"
        echo ""
    else
        print_warning "Services deployed but may not be running yet. Check status with: docker compose -f $TEMP_COMPOSE ps"
    fi
}

# Show current deployment status in main menu
show_current_deployment() {
    # This function is now integrated into print_selection
    # Keep it empty to avoid duplicate display
    return 0
}

# Main menu
main_menu() {
    while true; do
        print_header
        
        # Show current deployment status if exists
        show_current_deployment
        
        print_selection
        
        # Check if deployment exists for quick log access
        local compose_file="$PROJECT_ROOT/docker-compose.generated.yaml"
        local has_deployment=false
        if [ -f "$compose_file" ]; then
            has_deployment=true
        fi
        
        echo ""
        echo -e "${BLUE}Main Menu${NC}"
        echo ""
        echo -e "${GREEN}Deployment:${NC}"
        echo "  1) New Deployment"
        echo "  2) Manage Existing"
        echo "  3) Upgrade Version Information"
        if [ "$has_deployment" = true ]; then
            echo ""
            echo -e "${YELLOW}Quick Log Access:${NC}"
            if [ -n "$SELECTED_EC" ]; then
                echo -e "  ${CYAN}ec${NC}) Execution Client Logs"
            fi
            if [ -n "$SELECTED_CC" ]; then
                echo -e "  ${CYAN}cc${NC}) Consensus Client Logs"
            fi
            if [ -n "$SELECTED_MEV" ] && [ "$SELECTED_MEV" != "none" ]; then
                echo -e "  ${CYAN}mev${NC}) MEV-Boost Logs"
            fi
            if [ -n "$SELECTED_VC" ]; then
                echo -e "  ${CYAN}vc${NC}) Validator Client Logs"
            fi
            echo -e "  ${CYAN}all${NC}) All Services Logs"
        fi
        echo ""
        echo "  0) Exit"
        echo ""
        read -p "Select option: " choice
        
        # Validate input
        if [ -z "$choice" ]; then
            echo -e "${RED}No selection made${NC}"
            sleep 1
            continue
        fi
        
        case $choice in
            1) 
                # New deployment flow - Configuration menu
                new_deployment_menu
                ;;
            2) 
                # Maintenance menu
                if [ -f "$PROJECT_ROOT/docker-compose.generated.yaml" ]; then
                    bash "$LIB_DIR/maintenance.sh"
                else
                    print_warning "No existing deployment found. Please use 'New Deployment' first."
                    sleep 2
                fi
                ;;
            ec|EC)
                if [ "$has_deployment" = true ] && [ -n "$SELECTED_EC" ]; then
                    clear
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${CYAN}  Execution Client Logs (Real-time)${NC}"
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
                    echo ""
                    filter_logs_by_level "all" "execution-client"
                else
                    print_warning "No deployment or Execution Client found"
                    sleep 1
                fi
                ;;
            cc|CC)
                if [ "$has_deployment" = true ] && [ -n "$SELECTED_CC" ]; then
                    clear
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${CYAN}  Consensus Client Logs (Real-time)${NC}"
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
                    echo ""
                    filter_logs_by_level "all" "consensus-client"
                else
                    print_warning "No deployment or Consensus Client found"
                    sleep 1
                fi
                ;;
            mev|MEV)
                if [ "$has_deployment" = true ] && [ -n "$SELECTED_MEV" ] && [ "$SELECTED_MEV" != "none" ]; then
                    clear
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${CYAN}  MEV-Boost Logs (Real-time)${NC}"
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
                    echo ""
                    filter_logs_by_level "all" "mev-boost"
                else
                    print_warning "No deployment or MEV-Boost found"
                    sleep 1
                fi
                ;;
            vc|VC)
                if [ "$has_deployment" = true ] && [ -n "$SELECTED_VC" ]; then
                    clear
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${CYAN}  Validator Client Logs (Real-time)${NC}"
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
                    echo ""
                    local vc_service=""
                    case "$SELECTED_VC" in
                        lighthouse) vc_service="lighthouse-vc" ;;
                        teku) vc_service="teku-vc" ;;
                        lodestar) vc_service="lodestar-vc" ;;
                        *) vc_service="$SELECTED_VC" ;;
                    esac
                    filter_logs_by_level "all" "$vc_service"
                else
                    print_warning "No deployment or Validator Client found"
                    sleep 1
                fi
                ;;
            all|ALL)
                if [ "$has_deployment" = true ]; then
                    clear
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${CYAN}  All Services Logs (Real-time)${NC}"
                    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
                    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
                    echo ""
                    filter_logs_by_level "all" ""
                else
                    print_warning "No deployment found"
                    sleep 1
                fi
                ;;
            3)
                # Version Information
                bash "$LIB_DIR/version-check.sh"
                ;;
            0) echo "Goodbye!"; exit 0 ;;
            *) echo -e "${RED}Invalid selection${NC}"; sleep 1 ;;
        esac
    done
}

# Initialize
load_config
main_menu


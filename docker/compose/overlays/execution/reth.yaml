version: "3.8"

services:
  #           _   _     
  #  _ __ ___| |_| |__  
  # | '__/ _ \ __| '_ \ 
  # | | |  __/ |_| | | |
  # |_|  \___|\__|_| |_|
  execution-client:
    image: ghcr.io/paradigmxyz/reth:${RETH_VERSION}
    container_name: execution-client-${NETWORK}
    ports:
      - "${EC_PORT_P2P}:30303/tcp"
      - "${EC_PORT_P2P}:30303/udp"
      - "${EC_PORT_HTTP}:8545"
      - "${EC_PORT_WS}:8546"
      - "${EC_PORT_ENGINE}:8551"
      - "${EC_PORT_METRIC}:6060"
    command: |
      node
      --config=/root/.local/share/reth/config.toml
      --chain=${NETWORK}
      --full
      --max-outbound-peers=${RETH_MAX_OUTBOUND_PEERS:-100}
      --max-inbound-peers=${RETH_MAX_INBOUND_PEERS:-50}
      --metrics=0.0.0.0:6060
      --log.file.directory=/root/logs
      --log.file.max-size=${RETH_LOG_MAX_SIZE:-100}
      --log.file.max-files=${RETH_LOG_MAX_FILES:-5}
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.jwtsecret=/jwt/jwt.hex
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.api="eth,net,web3"
      --http.corsdomain="*"
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api="eth,net,web3"
      --ws.origins="*"
      --builder.gaslimit=${EC_GAS_LIMIT:-60000000}
      --db.log-level=${RETH_DB_LOG_LEVEL:-Warn}
      --txpool.max-account-slots=${RETH_TXPOOL_MAX_ACCOUNT_SLOTS:-16}
      --rpc.max-request-size=${RETH_RPC_MAX_REQUEST_SIZE:-10}
      --rpc.max-response-size=${RETH_RPC_MAX_RESPONSE_SIZE:-10}
      --rpc.max-logs-per-response=${RETH_RPC_MAX_LOGS:-10000}
    networks:
      - ethnode
    volumes:
      - ${PROJECT_ROOT}/data/reth/${NETWORK}:/root/.local/share/reth
      - ${PROJECT_ROOT}/security/jwt/${ENV}/jwt.hex:/jwt/jwt.hex:ro
      - ${PROJECT_ROOT}/data/logs:/root/logs
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6060/metrics"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 300s
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    labels:
      - "com.ethereum.client=reth"
      - "com.ethereum.network=${NETWORK}"
      - "com.ethereum.role=execution"

